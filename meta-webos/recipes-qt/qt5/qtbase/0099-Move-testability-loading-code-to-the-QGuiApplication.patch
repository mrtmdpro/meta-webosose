From 41145af0b3234b1b8b06af8a75de1732f43d7cac Mon Sep 17 00:00:00 2001
From: Tigran Avanesov <tigran.avanesov@lge.com>
Date: Fri, 25 Jul 2014 11:13:10 +0300
Subject: [PATCH] Move testability loading code to the QGuiApplication

Move testability loading code to the QGuiApplication from
QApplication to make no changes in existing QML applications and
be able to use -testability switch.

Change-Id: Ieb0ace469028f37be868d031946e37715e61b8af
Signed-off-by: Martin Jansa <Martin.Jansa@gmail.com>
---
 src/gui/kernel/qguiapplication.cpp  | 39 +++++++++++++++++++++++++++++
 src/gui/kernel/qguiapplication.h    |  3 ++-
 src/gui/kernel/qguiapplication_p.h  |  1 +
 src/widgets/kernel/qapplication.cpp |  1 +
 4 files changed, 43 insertions(+), 1 deletion(-)

diff --git a/src/gui/kernel/qguiapplication.cpp b/src/gui/kernel/qguiapplication.cpp
index 9da325f46e..3f9e65b424 100644
--- a/src/gui/kernel/qguiapplication.cpp
+++ b/src/gui/kernel/qguiapplication.cpp
@@ -112,6 +112,10 @@
 
 #include <ctype.h>
 
+#ifndef QT_NO_LIBRARY
+#include "qlibrary.h"
+#endif
+
 QT_BEGIN_NAMESPACE
 
 // Helper macro for static functions to check on the existence of the application class.
@@ -139,6 +143,12 @@ bool QGuiApplicationPrivate::highDpiScalingUpdated = false;
 
 QVector<QGuiApplicationPrivate::TabletPointData> QGuiApplicationPrivate::tabletDevicePoints;
 
+#ifdef QT_DISABLE_TESTABILITY_BY_DEFAULT
+bool QGuiApplicationPrivate::load_testability = false;
+#else
+bool QGuiApplicationPrivate::load_testability = true;
+#endif
+
 QPlatformIntegration *QGuiApplicationPrivate::platform_integration = 0;
 QPlatformTheme *QGuiApplicationPrivate::platform_theme = 0;
 
@@ -586,6 +596,11 @@ QGuiApplication::QGuiApplication(int &argc, char **argv, int flags)
 {
     d_func()->init();
 
+    if (QGuiApplicationPrivate::load_testability)
+    {
+        loadTestability();
+    }
+
     QCoreApplicationPrivate::eventDispatcher->startingUp();
 }
 
@@ -595,6 +610,10 @@ QGuiApplication::QGuiApplication(int &argc, char **argv, int flags)
 QGuiApplication::QGuiApplication(QGuiApplicationPrivate &p)
     : QCoreApplication(p)
 {
+    if (QGuiApplicationPrivate::load_testability)
+    {
+        loadTestability();
+    }
 }
 
 /*!
@@ -660,6 +679,8 @@ QGuiApplicationPrivate::QGuiApplicationPrivate(int &argc, char **argv, int flags
     is_session_restored = false;
     is_saving_session = false;
 #endif
+
+    load_testability = true;
 }
 
 /*!
@@ -3839,6 +3860,24 @@ QInputDeviceManager *QGuiApplicationPrivate::inputDeviceManager()
 
     return m_inputDeviceManager;
 }
+void QGuiApplication::loadTestability()
+{
+#ifndef QT_NO_LIBRARY
+    QLibrary testLib(QLatin1String("qttestability"));
+    if (testLib.load()) {
+        qDebug() << "qttestability successfully loaded";
+        typedef void (*TasInitialize)(void);
+        TasInitialize initFunction = (TasInitialize)testLib.resolve("qt_testability_init");
+        if (initFunction) {
+            initFunction();
+        } else {
+            qCritical("Library qttestability resolve failed!");
+        }
+    } else {
+        qCritical("Library qttestability load failed!");
+    }
+#endif
+}
 
 #include "moc_qguiapplication.cpp"
 
diff --git a/src/gui/kernel/qguiapplication.h b/src/gui/kernel/qguiapplication.h
index 6721970222..064254ff86 100644
--- a/src/gui/kernel/qguiapplication.h
+++ b/src/gui/kernel/qguiapplication.h
@@ -191,8 +191,9 @@ protected:
     bool compressEvent(QEvent *, QObject *receiver, QPostEventList *) Q_DECL_OVERRIDE;
 
     QGuiApplication(QGuiApplicationPrivate &p);
-
 private:
+    static void loadTestability();
+
     Q_DISABLE_COPY(QGuiApplication)
     Q_DECLARE_PRIVATE(QGuiApplication)
 
diff --git a/src/gui/kernel/qguiapplication_p.h b/src/gui/kernel/qguiapplication_p.h
index d67ab61ff8..c1d07c830d 100644
--- a/src/gui/kernel/qguiapplication_p.h
+++ b/src/gui/kernel/qguiapplication_p.h
@@ -214,6 +214,7 @@ public:
     static QWindow *currentMousePressWindow;
     static Qt::ApplicationState applicationState;
     static bool highDpiScalingUpdated;
+    static bool load_testability;
 
     struct TabletPointData {
         TabletPointData(qint64 devId = 0) : deviceId(devId), state(Qt::NoButton), target(Q_NULLPTR) {}
diff --git a/src/widgets/kernel/qapplication.cpp b/src/widgets/kernel/qapplication.cpp
index 26e9ffbbf0..1f1c4131ba 100644
--- a/src/widgets/kernel/qapplication.cpp
+++ b/src/widgets/kernel/qapplication.cpp
@@ -589,6 +589,7 @@ void QApplicationPrivate::init()
     extern void qt_gui_eval_init(QCoreApplicationPrivate::Type);
     qt_gui_eval_init(application_type);
 #endif
+
 #ifndef QT_NO_ACCESSIBILITY
     // factory for accessible interfaces for widgets shipped with Qt
     QAccessible::installFactory(&qAccessibleFactory);
